# Глава 5: Сигурност и качество

## 5.1 Въведение в сигурността на уеб приложенията

Сигурността е фундаментален аспект на всяка платформа за електронна търговия. Тя обхваща защитата на данните на потребителите, предотвратяването на неоторизиран достъп, осигуряването на целостта на транзакциите и поддържането на доверието на клиентите. Пропуски в сигурността могат да доведат до финансови загуби, правни проблеми и непоправими щети върху репутацията.

Платформата JustCases е проектирана с принципа за вградена сигурност, където защитата е интегрирана във всеки аспект на системата, а не добавена като допълнителен слой. Този подход гарантира, че сигурността е последователна и всеобхватна.

В тази глава ще разгледаме различните аспекти на сигурността в JustCases, включително управлението на достъпа, защитата на данните, валидацията на входящата информация, ограничаването на заявките и мониторинга на системата.

## 5.2 Управление на достъпа и роли

Системата за управление на достъпа определя кой може да извършва какви действия в платформата. Тя е базирана на роли, като всяка роля има дефиниран набор от права и ограничения.

В JustCases съществуват две основни роли за регистрирани потребители. Обикновените потребители имат достъп до клиентските функционалности като разглеждане на каталога, управление на количката, извършване на поръчки, писане на отзиви и управление на профила. Администраторите имат пълен достъп до всички функционалности, включително административния панел за управление на продукти, поръчки, потребители и системни настройки.

Ролите се съхраняват в базата данни като част от потребителския профил. При всяка заявка към защитен ресурс системата проверява ролята на потребителя и определя дали има право на достъп.

Административните маршрути са защитени на няколко нива. Първо, всички заявки към административните крайни точки изискват валидна потребителска сесия. Второ, системата проверява дали потребителят има администраторска роля. Трето, определени чувствителни операции могат да изискват допълнително потвърждение.

Принципът на най-малките привилегии се прилага последователно в системата. Всеки потребител и компонент има достъп само до ресурсите, необходими за изпълнение на техните функции. Това минимизира потенциалните щети при компрометиране на акаунт или компонент.

## 5.3 Автентикация и управление на сесии

Автентикацията е процесът на потвърждаване на самоличността на потребителя. В JustCases тя се осъществява чрез имейл адрес и парола, като паролата се сравнява с хешираната версия, съхранена в базата данни.

Съхранението на пароли следва индустриалните стандарти за сигурност. Паролите се хешират с алгоритъма bcrypt, който е специално проектиран за тази цел. Хешът включва автоматично генерирана сол, която предотвратява атаки с предварително изчислени таблици. Факторът на работа е настроен на ниво, което прави атаките с груба сила непрактични.

Управлението на сесиите осигурява непрекъснатост на автентикираното състояние между заявките. При успешна автентикация се създава сесия, която се съхранява на сървъра и се свързва с потребителя чрез сигурен идентификатор, предаван в бисквитки.

Сесиите имат ограничен срок на валидност, след който потребителят трябва да се автентикира отново. Това намалява риска от злоупотреба със стари или откраднати сесии.

Системата поддържа и издаване на JSON Web Token за случаи, изискващи токен-базирана автентикация. Токените се подписват с тайна ключова фраза и имат ограничен срок на валидност.

## 5.4 Валидация на входящи данни

Валидацията на входящите данни е критична защитна мярка срещу широк спектър от атаки. Тя гарантира, че само данни в очаквания формат и обхват се обработват от системата.

JustCases използва библиотеката Zod за дефиниране на схеми и валидация на данни. Zod позволява декларативно описание на структурата, типовете и ограниченията на данните. При несъответствие се генерира подробна информация за грешката, която помага на клиентската страна да покаже полезно съобщение на потребителя.

Валидацията се прилага на множество нива. На клиентската страна тя осигурява бърза обратна връзка за потребителя и предотвратява изпращането на очевидно невалидни данни. На сървърната страна тя действа като последна линия на защита и никога не се пропуска, дори ако клиентската валидация е преминала успешно.

Всички входящи данни се санитизират, за да се предотвратят инжекционни атаки. Специалните символи се екранират, дължините се ограничават и форматите се проверяват строго. Това е особено важно за данни, които се визуализират в потребителския интерфейс или се използват в заявки към базата данни.

Типичните валидации включват проверка на имейл адреси за правилен формат, проверка на пароли за минимална дължина и сложност, проверка на числови стойности за обхват и тип, проверка на текстови полета за максимална дължина и недопустими символи, както и проверка на идентификатори за правилен формат.

## 5.5 Ограничаване на заявките

Ограничаването на заявките, известно като rate limiting, е защитна мярка срещу злоупотреба с ресурсите на системата. То ограничава броя на заявките, които даден потребител или IP адрес може да направи в определен времеви период.

Тази мярка защитава срещу няколко типа атаки и злоупотреби. Атаките с груба сила, при които нападателят се опитва да познае парола чрез изпробване на множество варианти, стават непрактични поради ограничения брой опити. Атаките за отказ на услуга, целящи претоварване на сървъра с огромен брой заявки, се смекчават чрез отхвърляне на заявките над лимита. Изчерпването на ресурси от автоматизирани скриптове се предотвратява.

JustCases прилага различни лимити за различни типове операции. Операциите за автентикация като вход и регистрация имат по-строги лимити, тъй като са честа цел на атаки. Операциите за четене имат по-високи лимити, тъй като са по-малко рискови. Операциите за запис като създаване на поръчки или публикуване на отзиви имат умерени лимити.

При достигане на лимита системата връща подходящ отговор, указващ, че потребителят трябва да изчака преди да опита отново. Отговорът включва информация за това кога лимитът ще бъде нулиран.

## 5.6 Защита срещу често срещани атаки

Уеб приложенията са изложени на редица добре познати атаки и JustCases включва защити срещу всяка от тях.

Атаките тип Cross-Site Scripting, или XSS, се опитват да инжектират зловреден скрипт в страниците, който впоследствие се изпълнява в браузъра на други потребители. Защитата включва екраниране на потребителски въведеното съдържание при визуализация, използване на Content Security Policy заглавки за ограничаване на източниците на скриптове и избягване на използването на опасни методи за вмъкване на HTML.

Атаките тип Cross-Site Request Forgery, или CSRF, експлоатират доверието между браузъра и сървъра, за да накарат потребителя несъзнателно да извърши нежелано действие. Защитата включва използване на CSRF токени, които се валидират при всяка мутираща заявка, и проверка на заглавието Origin за потвърждаване на легитимността на заявката.

SQL инжекциите се опитват да манипулират заявките към базата данни чрез вмъкване на зловреден SQL код. Prisma, използваният инструмент за достъп до данни, автоматично параметризира заявките и предотвратява този тип атаки.

Атаките за прихващане на сесии се опитват да откраднат идентификаторите на сесиите и да ги използват за неоторизиран достъп. Защитата включва предаване на сесийните бисквитки само по HTTPS, използване на флага HttpOnly за предотвратяване на достъп от JavaScript и периодично обновяване на сесийния идентификатор.

## 5.7 Логиране и наблюдение

Логирането е съществен инструмент за наблюдение на системата, откриване на проблеми и разследване на инциденти. JustCases включва структурирана система за логиране, която записва важни събития и информация.

Логовете съдържат информация за различни типове събития. Те включват заявки към системата с метод, път и време за отговор, грешки и изключения с пълни детайли за контекста, автентикационни събития като успешни и неуспешни опити за вход, административни действия като промени в продукти или обработка на поръчки и системни събития като стартиране, спиране и конфигурационни промени.

Всеки лог запис включва времеви маркер, ниво на важност, съобщение и допълнителен контекст. Нивата на важност варират от debug за подробна информация за разработка, през info за нормални операции, warning за потенциални проблеми, до error за грешки, изискващи внимание.

За улесняване на проследяването на заявките през различните компоненти на системата се използва идентификатор на заявката. Този идентификатор се включва във всички логове, свързани с дадена заявка, което позволява лесно реконструиране на потока.

В производствена среда логовете се форматират като JSON за лесна обработка от системи за агрегиране на логове. В среда за разработка се използва по-четим формат за удобство на разработчиците.

## 5.8 Крайна точка за проверка на здравето

Крайната точка за проверка на здравето предоставя информация за състоянието на системата. Тя е полезна за наблюдение, автоматично мащабиране и балансиране на натоварването.

Проверката на здравето включва няколко аспекта на системата. Свързаността с базата данни се тества чрез изпълнение на проста заявка. Използването на паметта се наблюдава за откриване на потенциални изтичания. Времето от стартирането на приложението показва стабилността.

Резултатът от проверката включва общ статус, който може да бъде здрава, влошена или нездрава система, в зависимост от състоянието на отделните проверки. Ако базата данни е недостъпна или използването на паметта е критично, системата се маркира като нездрава. Ако има предупредителни индикатори, тя се маркира като влошена.

Тази крайна точка може да бъде използвана от системи за наблюдение за автоматично откриване на проблеми и известяване на екипа. Тя също може да бъде интегрирана с балансировчици на натоварване за автоматично изключване на нездрави инстанции от ротация.

## 5.9 Тестване и осигуряване на качеството

Тестването е критична част от процеса на разработка, която осигурява коректността и надеждността на кода. JustCases използва рамката Vitest за автоматизирано тестване.

Vitest е модерна тестова рамка, която се интегрира отлично с екосистемата на инструментите, използвани в проекта. Тя предлага бързо изпълнение на тестове, интуитивен синтаксис и богат набор от функционалности.

Тестовете в JustCases покриват различни аспекти на системата. Модулните тестове проверяват отделни функции и компоненти изолирано. Те гарантират, че всяка единица код работи правилно при различни входове и условия. Интеграционните тестове проверяват взаимодействието между компонентите. Те гарантират, че системата работи правилно като цяло, не само като сбор от отделни части.

Тестовете на компоненти проверяват поведението на React компонентите. Те симулират потребителски взаимодействия и проверяват резултатния изход. Тестовете използват React Testing Library за реалистични симулации на потребителско взаимодействие.

Стратегията за тестване включва непрекъсната интеграция, при която тестовете се изпълняват автоматично при всяка промяна в кода. Това осигурява бързо откриване на проблеми и предотвратява регресии.

Покритието на кода се измерва и проследява за гарантиране на адекватно тестване. Критичните части на системата като автентикацията, обработката на плащания и управлението на поръчки имат приоритет за тестово покритие.

## 5.10 Обработка на грешки

Правилната обработка на грешки е важна както за потребителското изживяване, така и за сигурността. Системата обработва грешките по начин, който предоставя полезна информация на потребителите, без да разкрива чувствителни детайли.

На клиентската страна се използват граници за грешки, които улавят грешки в компонентите и показват приятелско съобщение вместо счупена страница. Потребителите виждат информация за проблема и опции за действие като опитване отново или връщане към началната страница.

На сървърната страна всички API маршрути включват обработка на грешки, която логира детайлите за разследване и връща подходящи отговори на клиента. В производствена среда детайлите за грешките не се изпращат към клиента, за да не се разкрива чувствителна информация за системата.

Страниците за грешки са проектирани да бъдат информативни и полезни. Страницата за грешка 404 за липсващо съдържание предлага навигация към други части на сайта. Страницата за обща грешка предоставя опции за повторен опит и контакт с поддръжката.

## 5.11 Резервни копия и възстановяване

Защитата на данните включва и стратегия за резервни копия и възстановяване при бедствие. Загубата на данни може да бъде катастрофална за бизнеса и за клиентите.

Базата данни PostgreSQL поддържа различни механизми за резервно копие. Логическите резервни копия извличат данните в преносим формат, който може да бъде възстановен на друг сървър. Физическите резервни копия копират файловете на базата данни директно. Репликацията осигурява непрекъснато копиране на данните към резервен сървър.

Препоръчителната стратегия включва редовни автоматични резервни копия, съхранявани на отделно местоположение. Честотата зависи от критичността на данните и приемливата загуба. За платформа за електронна търговия дневните резервни копия са минимум, а за критични системи може да са необходими по-чести копия.

Важно е редовно да се тестват процедурите за възстановяване. Резервните копия са безполезни, ако не могат да бъдат възстановени успешно. Тестването гарантира, че процесът работи и че екипът е подготвен да реагира при нужда.

## 5.12 Заключение на главата

Сигурността и качеството са неразделни аспекти на платформата JustCases. Многопластовата защита обхваща управление на достъпа, сигурна автентикация, валидация на данни, ограничаване на заявки и защити срещу специфични атаки.

Системите за логиране и наблюдение осигуряват видимост в операциите и помагат за откриване на проблеми. Автоматизираното тестване гарантира коректността на кода и предотвратява регресии. Стратегията за резервни копия защитава данните срещу загуба.

В следващата глава ще разгледаме оперативните аспекти на платформата, включително конфигурацията, разгръщането и поддръжката.

---

*Продължение в Глава 6: Операции и поддръжка*

